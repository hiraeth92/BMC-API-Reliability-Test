# Workflow 名稱（會顯示在 GitHub Actions UI）
name: VQE API 可靠度與效能驗證

# 觸發條件：當有人 push 到 main 分支或發 PR 到 main 時會執行
on:
  push:
    branches: [ main ]        # 當程式碼推送到 main 分支時觸發
  pull_request:
    branches: [ main ]        # 當對 main 提 PR 時觸發（方便 CI 在合併前跑測試）

jobs:
  build:                      # 定義一個 job，名稱為 build
    # 策略：使用 matrix 在多個 Python 版本上並行執行，fail-fast=false 表示某一環節失敗仍會跑完其他組合
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.10", "3.11"]   # 在 Python 3.10 與 3.11 上各跑一次

    runs-on: ubuntu-latest    # 指定 runner 環境為 最新版 Ubuntu

    # 全局環境變數，可在步驟中以 ${{ env.VAR }} 或 process env 取得（也會被子步驟繼承）
    env:
      TARGET_URL: "https://www.google.com/robots.txt"   # 測試目標 URL（可在 pipeline 執行時改成真實 BMC API）
      NUM_REQUESTS: 50                                  # 併發請求數（可透過 os.getenv 在程式中讀取）
      LATENCY_THRESHOLD_MS: 2000                        # 延遲閾值 (ms)

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      # 取出 repository 程式碼，後續步驟才能在 runner 上執行程式

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
      # 根據 matrix 的版本設定 Python 環境（例如 3.10 / 3.11）

    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        # 緩存鍵：根據 runner OS + python 版本 + requirements.txt 的雜湊值
        key: ${{ runner.os }}-pip-${{ matrix.python-version }}-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-${{ matrix.python-version }}-
      # 使用快取以加速後續 CI 執行（避免每次都重下載套件）

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        # 若你有 requirements.txt，建議改為: pip install -r requirements.txt
        pip install pytest requests
      # 安裝專案所需的套件（pytest 與 requests 為測試與 API 請求所需）

    - name: Run VQE Reliability Tests and Generate Report
      run: |
        # -v：verbose，-s：讓標準輸出直接顯示（避免被 pytest 捕獲）
        # --junitxml：生成 JUnit 格式的 XML 報告，方便整合 CI 的報告視覺化
        pytest -v -s test_reliability.py --junitxml=vqe-report-${{ matrix.python-version }}.xml
      # 執行你的 pytest 測試檔，並輸出每個 Python 版本對應的 XML 報告

    - name: Upload Test Report Artifact
      if: always()   # 無論前一步是否失敗，都強制上傳報告（避免失敗時無報告可查）
      uses: actions/upload-artifact@v4
      with:
        name: VQE-Test-Report-Python-${{ matrix.python-version }}
        path: vqe-report-${{ matrix.python-version }}.xml
      # 將 pytest 生成的報告上傳為 artifact，供後續下載或在 PR 中檢視

    # (可選) 若你想保留 runner 的 log 或其他產物，也可以在此加入 upload-artifact 步驟
